---
title: 对极几何（一）
date: 2024-05-09 11:15:27
tags: computer vision
categories: 多视角几何
mathjax: true
---

# 1. 简介

前面我们知道了如何计算相机矩阵，但是无法从一张图片中恢复出完整的 3D 世界结构。本文主要讲述当多个相机进行拍摄时，如何从中尽可能地得到空间几何信息。首先是定义两个视角中的几何然后说明这个几何如何进一步帮助我们了解周围世界。

# 2. 对极几何

如图 1 所示，

![](/images/dip/epi_geo_1.jpg)
<center>图 1</center>

空间中一个 3D 点 P，投影到多个相机图像面，像这样的关系到相机，空间 3D 点以及对应的像平面点的几何称为对极几何。

标准对极几何有两个相机观察空间中点 $P$，其在相机图像平面的投影分别为 $p$ 和 $p'$，相机中心位于 $O_1$ 和 $O _ 2$。

概念：

**基线：**    相机中心的连线 $O_1 O_2$

**对极平面：** 相机中心与 P 形成的平面 $O_1 O_2P$

**对极点：** 基线与图像面的交点 $e,\  e'$

**对极线：** 对极平面与图像平面的交线 $pe, \ p'e'$。对极线与基线相交在对极点。


一个特殊的情况是两个图像面平行，

![](/images/dip/epi_geo_2.jpg)

<center>图 2</center>

此时对极点位于无穷远处，对极线与图像的一个轴平行。

实际情况中，我们没有空间点 P 的准确位置坐标，但是有其在图像面的投影 $p$ 的位置信息，我们也知道相机的位置朝向（外参）和内参，据此，我们能得到什么？

根据相机位置 $O_1, O_2$ 以及图像点 $p$，我们可以得到对极平面，然后得到对极线，P 投影到第二个图像面 $p'$ 点，其也位于第二个图像的对极线上，所以根据对极几何的关系，在空间 3D 结构未知的情况下，两个图像之间也有很强的约束关系。

给定图 3 的对极几何关系，

![](/images/dip/epi_geo_3.jpg)
<center>图 3</center>

定义相机矩阵为 $M, \ M'$，将 3D 空间点映射到 2D 图像面上。假设世界坐标系与第一个相机重合，第二个相机经过一个旋转 $R$ 和一个平移 $T$，可以得到第一个相机外参 $[I|\mathbf 0]$。那么相机矩阵为

$$M=K[I|\mathbf 0], \quad M'=K'[R^{\top}|-R^{\top}T] \tag{1}$$

# 3. 本质矩阵

我们考虑标准相机，其中 $K=K'=I$，那么 (1) 式变为

$$M=[I|\mathbf 0], \quad M'=[R^{\top}|-R^{\top}T] \tag{2}$$

记 3D 空间点的齐次坐标为 $P=[\hat P ^{\top} |1]^{\top}$，于是有

$$p=MP=\hat P + \mathbf 0 = \hat P
\\ p'=M'P=R ^{\top} \hat P-R^{\top}T$$

使用 $p'$ 表示 $p$，解上面两式得，

$$p=Rp'+T \tag{3}$$

因为以第一个相机作为世界坐标系，并且相机内参为单位矩阵 $I$，那么显然 $p$ 的 3D 坐标在对极平面内，即 $Rp'+T$ 在对极平面内，另外 $T$ 也在对极平面内，因为 $T$ 就是向量 $\vec {O_1O_2}$（注意旋转矩阵 $R$ 仅仅改变的是相机朝向，不影响相机中心位置），所以将这两个向量叉乘，得到一个垂直于对极平面的向量 $T \times (R p'+T)=T \times (Rp')$，这个向量与 $p$ 垂直，故

$$p^{\top}\cdot [T \times (Rp')]=0\tag{4}$$

然后改写为以下形式

$$p ^ {\top} [T _ {\times}]Rp'=0 \tag{5}$$

其中 

$$T=\begin{bmatrix}T _ x \\ T _ y \\ T _ z\end{bmatrix}, \quad T _ {\times}=\begin{bmatrix}0 & -T _ z & T _ y
\\ T _ z & 0 & - T _ x
\\ -T _ y & T _ x & 0 \end{bmatrix}$$

$E=[T _ {\times}]R$ 称为 **本质矩阵**，那么对极约束关系为

$$p ^ {\top} E p'=0 \tag{6}$$

本质矩阵 $E$ 中有 6 个未知数（$T, R$ 各 3 个），所以最高自由度为 6，加上本质矩阵满足尺度等价性约束，这是指对 $E$ 乘上一个非 0 因子，仍然满足 (6) 式约束，即，还是一个本质矩阵，所以要对尺度进行约束，例如令最后一个元素 $E _ {33}=1$ ，故本质矩阵 $E$ 的自由度为 5，并且秩为 2（也是因为尺度约束的原因），是一个奇异矩阵 $\det E=0$ 。

本质矩阵对计算对极线非常有用。


**结论1：** $l'=E ^ {\top} p$ 表示第二个相机图像面的对极线

**结论2：** $l=E p'$ 表示第一个相机图像面的对极线

如何理解上面两句话？

如何表示一个直线？$\mathbf l=(a, b, c)^{\top}$，表示 $ax+bx+c=0$

如何表示一个 2D 点？$\mathbf x=(u, v, 1)^{\top}$

如何表示点 $\mathbf x$ 在直线上？$\mathbf l ^ {\top}\mathbf x =au+bv+c=0$ 就表示在直线上。

现在，对于 $l'$，显然 $p'$ 和 $e'$ 在这条直线上，验证

$$l ^ {'\top} p'=p^{\top}E p'=0\tag{7}$$

$$l ^ {'\top} e'=(p^{\top}E) (M'O _ 1)=(p^{\top}E)(-R ^ {\top}T)=-p^{\top}[T _ {\times}]R R ^{\top}T=-p^{\top}(T\times T)=0\tag{8}$$

其中 $O _ 1 = (0,0,0,1)^{\top}$

所以结论1 成立，类似地可以验证结论2 也成立。

本质矩阵与对极点的向量内积为 0：$E ^{\top}e=Ee'=0$，这在上面 (8) 式中已经验证过了。

# 4. 基础矩阵

现在我们考虑非标准相机，即 $K\ne I,K'\ne I$，那么

$$M=K[I|\mathbf 0], \quad M'=K'[R ^ {\top}|-R ^{\top}T] \tag{9}$$

这里仍然将世界坐标系建立在第一个相机上。

定义 $p _ c = K ^ {-1} p, \quad p _ c'=K^{'-1}p'$，这样 $p _ c$ 和 $p_c'$ 就是空间 3D 点 P 在标准相机的像点（然后再分别经过 $K$ 和 $K'$ 得到非标准相机的像点 $p$ 和 $p'$），注意到在标准相机中有约束关系

$$p _ c^{\top}[T _ {\times}]R p _ c'=0$$

代入 $p_c,p_c'$ 的表达式，那么

$$p^{\top}K^{-\top}[T _ {\times}]R K^{'-1}p'=0\tag{10}$$

$F=K^{-\top}[T _ {\times}]R K^{'-1}$ 称为 **基础矩阵**。

于是 $E=K^{\top}FK'$，以及 $F=K^{-\top}EK^{'-1}$ 。

即使相机矩阵 $K, K'$ 和 $R, T$ 未知，也可以通过基础矩阵来计算对极线。

**结论3：** $l'=F ^{\top} p$ 是第二相机的对极线

**结论4：** $l=Fp'$ 是第一相机的对极线

验证一下结论3：

$$l'^{\top}p'=p^{\top}Fp'=0$$

$$\begin{aligned}l'^{\top}e'&=(p^{\top}F)(M'O _ 1)
\\ &=(p^{\top}F)(-K'R ^ {\top}T)
\\ &=-p^{\top}K^{-\top}[T _ {\times}]R K^{'-1}K'R ^ {\top}T
\\ &=0
\end{aligned}$$

基础矩阵的自由度为 7，而本质矩阵自由度为 5。

**基础矩阵的作用**

如果我们知道了基础矩阵，那么给定一个图像点 $p$，就知道另一个图像上的对极线 $l'=F ^ {\top}p$。

## 4.1 8 点算法

给定相同场景的两个图像，相机投影矩阵未知，我们可以使用 8 点算法估计基础矩阵。

给定来自两个图像中至少 8 个点对，如图 4，

![](/images/dip/epi_geo_4.jpg)
<center>图 4</center>

记 $p _ i=(u _ i, v _ i, 1)$ 和 $p_i'=(u_i',v_i',1)$，根据对极约束条件 $p_i^{\top}Fp'=0$，展开得

$$\begin{bmatrix}u_i u_i' & v_i'u_i & u _i & u_i'v_i & v_iv_i' & v_i & u_i' & v_i' &1\end{bmatrix}\begin{bmatrix}F_{11}\\ F_{12}\\ F _{13} \\ F_{21} \\ F_{22} \\ F_{23} \\ F_{31} \\ F_{32} \\ F_{33}\end{bmatrix}=0 \tag{11}$$

$F$ 包含 9 个未知数，但是根据尺寸不变约束，我们需要至少 8 个上面的方程即可求解，使用矩阵表示为

$$W \mathbf f=\mathbf 0 \tag{12}$$

其中 $W$ 是 $n \times 9$ 的矩阵，$n\ge 8$。

实际上，多于 8 个点对会更好，更大 size 的 $W$ 可以降低噪声影响。

解 (12) 式，对 $W$ 进行 SVD 分解，然后最小奇异值对应的右奇异向量就是 $F$ 的一个估计值，记为 $\hat F$，但是 $\hat F$ 可能是满秩的，而 $F$ 秩为 2，所以还需要再求解

$$\min _ F \ ||F-\hat F||_F, \quad s.t. \ \det F=0 \tag{13}$$

要解 (13) 式，对 $\hat F$ 进行 SVD 分解，$\hat F=U\Sigma V ^{\top}$，然后得到解

$$F=U\begin{bmatrix} \Sigma _ 1 & 0 & 0\\0 & \Sigma _ 2 & 0 \\ 0 & 0 & 0 \end{bmatrix} V ^ {\top} \tag{14}$$

## 4.2 归一化 8 点算法

实际上，8 点算法计算出来的 $F$ 还不准确，这使得 $p _ i$ 与 $l _ i=F p _ i'$ 的距离较大（有 10+ 像素距离），而 $p _ i$ 应该在对极线 $l _ i$ 上，距离应该为 0。

标准 8 点算法问题的根源是 $W$ 的 SVD 是病态的。正常情况下，经过 SVD 后，$W$ 有一个奇异值为 0 或者接近 0，其他奇异值则非 0，但是由于 $p _ i =(u _i, v_i, 1)^{\top}$ 通过有非常大的 $u_i, v_i$ 值（现代手机分辨率非常大，例如 $p _ i =(1832 , 1023, 1)^{\top}$），如果组成 $W$ 的点位于图像中一个较小的区域中，那么所有点的坐标 $p _ i$ 会非常相似，对 $p'$ 也是如此，这就导致 $W$ 会有一个较大的奇异值，而其他奇异值均非常小。

为了降低这种错误，使用归一化 8 点算法。我们分别对 $\{p_i\} _ {i=1}^n$ 和 $\{p_i'\} _ {i=1}^n$ 分别进行归一化：

1. 点的中心（平均点）为 $(0,0)^{\top}$
2. 点到中心的距离的平均为 $\sqrt 2$

归一化的具体操作与 [2D 单应变换](/2024/05/08/dip/2D_homography) 中一样，记我们对 $p _ i$ 和 $p _ i'$ 归一化的变换矩阵分别为 $T$ 和 $T'$，

$$q _ i = T p _ i, \quad q_i'=T'p_i' \tag{15}$$

然后使用 $q _ i, q _ i'$ 构造 $W$，根据标准 8 点算法，求出 $F _ q$，然后再去归一化得到

$$F=T^{'\top} F _ q T \tag{16}$$

# 5. 图像校正

我们考虑两个相机的图像面平行的情况，即上面图 2，首先计算本质矩阵 $E$。假设两个相机的内参 $K$ 相同，并且相机 2 相对于相机 1 只有 x 轴平移，$T=(T_x,0,0)$，没有旋转，$R=I$，根据定义有

$$E=[T _ {\times}]R=\begin{bmatrix}0&0&0
\\ 0&0&-T_x
\\0&T_x&0\end{bmatrix}\tag{17}$$

现在来计算对极线的方向，

$$l=Ep'=\begin{bmatrix}0&0&0
\\ 0&0&-T_x
\\0&T_x&0\end{bmatrix}\begin{bmatrix} u' \\ v' \\ 1\end{bmatrix}
=\begin{bmatrix}0\\ -T_x \\ T _ x v'\end{bmatrix}\tag{18}$$

这里计算 $l$ 时为啥不考虑 $K$？因为 $K$ 包含两个操作：平移和缩放，均不影响对极线方向，而这里我们仅考虑对极线的方向。

从 (18) 式可以看出 $l$ 是水平方向，因为写成直线方程为 $l ^{\top} (u,v,1)^{\top}=-vT_x+T_xv'=0$，这里只有一个变量 $v$。$l'$ 也是类似地为水平方向。

如果利用对极约束条件 $p^{\top}Ep'=0$，那么将得到 $v=v'$，这表示 $p$ 和 $p'$ 具有相同地 v 坐标（即图像坐标系的 y 坐标，表示在图像中具有相同的高度），因此对应点之间存在这样一个非常直观的关系。

如图 5，将两个虚线表示的图像面校正到实线表示的图像面，

![](/images/dip/epi_geo_5.jpg)
<center>图 5</center>

我们不需要知道相机矩阵 $K, K'$，也不需要知道两个相机之间的旋转和平移 $R,T$，直接根据归一化 8 点算法计算处基础矩阵 $F$，然后再根据点 $p, p'$ 计算出对应的对极线 $l, l'$。

假设有 $n\ge 8$ 个点对，对于图像面一（第一个相机的图像面），就有 $n$ 个对极线，这些对极线的交于一点：对极点。然而实际上，由于测量误差（使得 $p_i$ 的位置不那么准），这些对极线可能不相交于同一点，此时，通过最小化一个点到所有对极线的距离之和，求得对极点。

一个对极线 $l_i=[l_{i1}, l_{i2},l_{i3}]^{\top}$，线上点为 $\{x|l _ i^{\top}x=0\}$，那么对于对极点 $e$，有

$$\begin{bmatrix} l_1^{\top} \\ \vdots \\ l _ n^{\top}\end{bmatrix} e = \mathbf 0 \tag{19}$$

对 (19) 式中 $e$ 左边的系数矩阵，使用 SVD 分解，最小奇异值对应的右奇异向量就是 $e$ 的解。

使用类似的方法解出 $e'$，那么我们会发现这俩对极点不在水平轴无穷远处。如果对极点在水平轴无穷远处，根据前面分析，那么两个图像应该是平行的。那么，如何找到一个单应变换使得 $e$ 位于水平方向的无穷远处？

我们记这样的单应变换分别为 $H_1, H_2$。首先求解 $H _2$，它将对极点 $e'$ 映射到水平轴无穷远点 $(f, 0, 0)^{\top}$。

射影几何中，无穷远点均在无穷远线$l _ {\infty}(0,0,1)^{\top}$上，所以水平轴无穷远点坐标的第三个元素值必须为 0，对极线是水平直线形式为 $l'=(0, l_2, l_3)$，由于对极点位于对极线上，所以对极点的第二个坐标也是 0。也可以通过 $e'=M'O_1=K[R^{\top}|-R^{\top}T] [0,0,0|1]^{\top}=-KT$ 求对极点，这里图像平行时两个相机的位置偏移为 $T=(T_x,0,0)^{\top}$，所以 $e'=(fT_x,0,0)^{\top}$。这里的 $f$ 与前面无穷远点 $(f,0,0)^{\top}$ 的不同，一个是相机焦距（这里是未知的），一个是无穷远点齐次坐标的第一个元素，我们也可以使用其他符号表示，这第一个元素值下面会给出。

> 记住 $e'=(fT_x,0,0)^{\top}$ 是理论值，由于相机参数未知，所以理论值也未知，我们通过 (19) 式计算出 $e'$ 的估计值，然后通过某种变换进行图像校正。

满足条件的单应变换有很多，我们选择一个合适的变换，即包含一个平移和一个旋转（围绕图像中心旋转）。

首先将图像平移，使得图像中心位于齐次坐标 $(0,0,1)^{\top}$，平移操作的变换矩阵为

$$T=\begin{bmatrix}1 & 0 & -w/2\\0&1&-h/2 \\0&0&1\end{bmatrix}\tag{20}$$

然后使用一个旋转变换，将对极点置于水平轴 $(f,0,1)$ 处。前面图像经过平移后，对极点为 $Te'=(e_1',e_2',1)^{\top}$，这里 $e'$ 那么易知旋转变换矩阵为

$$R=\begin{bmatrix}\alpha \frac {e_1'}{\sqrt{e_1^{'2}+e_2^{'2}}} & \alpha \frac {e_2'}{\sqrt{e_1^{'2}+e_2^{'2}}} & 0
\\ -\alpha \frac {e_2'}{\sqrt{e_1^{'2}+e_2^{'2}}} & \alpha \frac {e_1'}{\sqrt{e_1^{'2}+e_2^{'2}}} & 0
\\ 0&0&1\end{bmatrix}\tag{21}$$

当 $e_1' \ge 0$ 时 $\alpha=1$，否则 $\alpha=-1$。

然后将 $(f,0,1)$ 变换到 $(f,0,0)$ 的变换矩阵为

$$G=\begin{bmatrix}1&0&0\\ 0&1&0 \\ -1/f &0&1\end{bmatrix}\tag{22}$$

最后需要逆平移到原图像空间，即使用 $T^{-1}$ 操作，所以单应变换为

$$H_2=T^{-1}GRT \tag{23}$$

然后我们通过下式找到第一个图像面的单应变换

$$\arg \min _ {H _1} \ \sum _ i ||H_1p_i - H_2p_i'||^2 \tag{24}$$

这是说，分别经过两个单应变换校正后的两个图像中，点对的坐标应该对应相同。

我们直接给出满足条件的 $H_1$ 具有如下形式，

$$H_1=H_A H_2 M \tag{25}$$

其中 $F=[e] _ {\times}M$，并且

$$H_A=\begin{bmatrix}a_1 & a_2 & a_3\\ 0&1&0 \\ 0&0&1\end{bmatrix}\tag{26}$$

$\mathbf a = (a_1,a_2,a_3)$ 后面讨论如何计算。

$3\times 3$ 的反对称矩阵（即 $A^{\top}=-A$）一个有趣的性质是 $A=A^3$ up to scale（即 $A$ 和 $A^3$ 仅差一个非零乘性因子）。任意叉乘矩阵 $[e] _ {\times}$ 均为反对称矩阵（见上文 (5) 式中的 $T _ {\times}$，然后基础矩阵 $F$ 也是 up to scale，于是

$$F=[e] _ {\times} M=[e] _ {\times}[e] _ {\times}[e] _ {\times}M=[e] _ {\times}[e] _ {\times}F \tag{27}$$

于是有

$$M=[e] _ {\times}F \tag{28}$$

> up to scale 的意思是矩阵乘以一个常数之后不影响矩阵的性质。在射影几何中，up to scale 也可以简单理解为矩阵的 scale 不影响。

如果 $M$ 的列加上 $v_i e$，其中 $v_i \in \mathbb R$，那么 $F=[e] _ {\times} M$ 仍满足 up to scale，因此 $M$ 的更一般的形式为

$$M=[e] _ {\times}F + ev^{\top} \tag{28}$$

一般地，设置 $v^{\top}=[1, 1, 1]$ 。

计算出了 $M$，还要计算 $H _ A$ 也就是 $\mathbf a$ 的值，才能得到 $H _ 1$。根据 (24) 式，使用 $\hat p_i=H _ 2 M p _ i$ 和 $\hat p_i'=H_2 p_i'$ 进行代替，那么 (24) 式变为

$$\arg \min _ {H _ A} \ \sum _ i ||H_A \hat p_i' - \hat p_i'||^2 \tag{30}$$

令 $\hat p _ i=(\hat x_i, \hat y_i, 1)$，$\hat p_i'=(\hat x_i', \hat y_i', 1)$，并代入 (26) 式，那么上述最小化问题变为

$$\arg \min _ {\mathbf a} \ \sum _ i (a_1 \hat x_i + a_2 \hat y_i+a_3-\hat x_i')^2+(\hat y_i - \hat y_i')^2 \tag{31}$$

由于 $n$ 个点对固定，故 $\hat y_i - \hat y_i'$ 是一个常量，于是上式简化为

$$\arg \min _ {\mathbf a} \ \sum _ i (a_1 \hat x_i + a_2 \hat y_i+a_3-\hat x_i')^2 \tag{32}$$

上式可写成一个最小二乘问题 $W \mathbf a = \mathbf b$，其中要求向量 $\mathbf a$，且有

$$W=\begin{bmatrix}\hat x_1' & \hat y_1 & 1 \\ \vdots & \vdots & \vdots \\ \hat x_n & \hat y_n & 1\end{bmatrix}, \quad \mathbf b = \begin{bmatrix}\hat x_1' \\ \vdots \\ \hat x_n'\end{bmatrix}$$

$n$ 个点对 $\{p_i \leftrightarrow p_i'\}$ 是已知的，$H_2$ 和 $M$ 根据上面的分析也可以计算出来，于是 $W, \mathbf b$ 也可以计算出来。

这是一个超定方程组，即 $W$ 的行数大于列数，通常是无解的，使用最小二乘法求解：

1. 计算 $W$ 的 QR 分解或者 SVD 分解
2. 将 $\mathbf b$ 投影到 $W$ 的列空间中，得到投影向量 $\mathbf p$
3. 求解 $R \mathbf x=\mathbf p$，其中 $R$ 是 $W$ 的上三角部分
4. 最小二乘解为 $\mathbf a'=Q \mathbf x$，取 $\mathbf a'$ 的前 3 个元素就得到 $\mathbf a$

代码演示：

```python
import numpy as np

# QR 分解法
A = np.array([[1, 4, 5], [1, -2, 3], [1, 4, 1], [1, -2, -1]])
b = np.array([6, 0, -4, 2])
Q, R = np.linalg.qr(A)      # Q: (4, 3), R: (3, 3)
p = Q.T @ b                 # (3, 1)
y = np.linalg.solve(R, p)   # (3, 1)
x = Q @ y                   # (4, 1) 取前 3 个元素
print(x)

# SVD 分解法
A = np.array([[2, 4, 5], [1, 6, 3], [1, 4, 1], [1, -2, 4]])
b = np.array([3, 1, -4, 2]) # (4, 1)
U, s, Vt = np.linalg.svd(A, full_matrices=False)
# U: (4, 3), s: (3, ), Vt: (3, 3)
p = U.T @ b             # (3, 1)
y = np.divide(p, s)     # (3, 1)
x = Vt.T @ y            # (3, 1)
print(x)
```

## 5.1 up to scale

齐次坐标中，例如

$(1,2,3,1), (2,4,6,2), (3,6,9,3)$

均表示相同的 3D 向量，它们两两之间相差一个非零乘性因子，所以我们称齐次坐标是 up to scale，即向量的 scale 不影响。
