---
title: 线性规划的单纯形方法
date: 2021-10-15 09:18:05
tags: linear programming
mathjax: true
---

线性规划问题在应用中很常见，有必要搞清楚如何解决这类问题。常用的方法有单纯形方法（The Simplex Method）
<!--more-->

# 基本形式
优化问题可以写成如下形式：

$$\min \ \mathbf {cx}=z\\\\
s.t. \ A \mathbf {x=b} \\\\
\quad \mathbf x \ge \mathbf 0$$


## 形式转换
对于不同于上述形式的线性规划问题，我们可以转换成上述形式。

1. 不等式约束条件

    对于约束条件，如果存在不等式，可以通过增加变量的方式转为不等式。例如 $a_1x_1+a_2x_2\le b$，那么增加一个变量 $e_1 \ge 0$，不等式变为 $a_1x_1+a_2x_2+e_1=b$，如果是 $a_1x_1+a_2x_2\ge b$，那么增加变量 $e_1$ 后，不等式变为 $a_1x_1+a_2x_2-e_1=b$。**对每一个不等式，增加一个独立的变量 $e_i \ge 0$，而不能是相同的变量。** 通常，对于 "$\le$"  的不等关系，添加的辅助变量称为松弛变量 （slack variable），而 "$\ge$" 不等关系对应的则为过载变量（excess variable）。

2. 符号非受限变量

    如果在实际线性规划问题中，某个变量是为负，即“符号非受限变量”，例如 $x_j$，那么可以使用 $x_j'-x_j''$ 代替 $x_j$，其中 $x_j', x_j'' \ge 0$。

3. 最小 or 最大目标函数

    如果是最大化目标函数 $\max \ z$，那么可以先求 $\min \ (-z)$，然后对最优目标值取反即可。


# 单纯形方法

## 先导概念

对于 $A \mathbf {x=b}, \ \mathbf x \ge \mathbf 0$，其中 $A \in \mathbb R^{m,n}$，$\mathbf b \in \mathbb R^m$。

假设 $\ rank(A,\mathbf b)=rank(A)=m$ ：

这个假设是合理的，如果 $rank(A)<m$，这说明方程组 $A \mathbf {x=b}$ 有 $m-rank(A)$ 个方程是冗余的，如果 $rank(A,\mathbf b)>rank(A)$，那么  $A \mathbf {x=b}$ 无解。另一方面，$m \ge rank(A,\mathbf b)\ge rank(A)$ 在任何条件下恒成立，如果 $rank(A)=m$，那么自然有 $rank(A,\mathbf b)=rank(A)=m$ 。

将矩阵 $A$ 的列重新排列为 $A=[B, N]$，使得 $B \in \mathbb R^{m,m}$ 是可逆矩阵，$\mathbf x=\begin{bmatrix}\mathbf x_B \\ \mathbf x_N\end{bmatrix}$ 是 $A \mathbf {x=b}$ 的解，其中 $\mathbf x_B=B^{-1}\mathbf b$，且 $\mathbf x_N=\mathbf 0$ 。注意满足 $[B, N]\begin{bmatrix}\mathbf x_B \\ \mathbf x_N\end{bmatrix}=\mathbf b$ 的 $\mathbf x_B$ 不一定只能是 $B^{-1}$，同样 $\mathbf x_N$ 不一定只能是 $\mathbf 0$。$\mathbf x_B=B^{-1}\mathbf b, \ \mathbf x_N=\mathbf 0$ 只是其中一个解（称为基本解）。

如果满足 $\mathbf x_B=B^{-1}\mathbf b \ge \mathbf 0$，称 $\mathbf x$ 是一个 **基本可行解**，回顾一下 $A=[B, N]$，其中 $B$ 是 m 阶可逆矩阵，这相当于已知 $n$ 列里面 **最多** 有 $m$ 个线性无关的列， 显然要选取这 $m$ 个线性无关的列，有 $\begin{pmatrix}n \\ m \end{pmatrix}$ 取法，所以自然有 $\begin{pmatrix}n \\ m \end{pmatrix}$ 个 $B$，称 $B$ 为基本矩阵，$N$ 为非基本矩阵，$\mathbf x_B$ 中各元素为 **基本变量** ，$\mathbf x_N$ 中各元素为 **非基本变量** 。

## 方法实现

使用表格形式实现单纯形方法，初始表格形式为

|$z$|-$\mathbf c$|0|
|---|---|---|
|$\mathbf 0$|A|$\mathbf b$|

这是根据 $z-\mathbf {cx}=0$ 以及 $A\mathbf {x=b}$，然后省略了 $\mathbf x$，按列可以分为三个部分，第一部分表示优化目标 $z$，第二部分表示 $\mathbf x$ 的系数，每列对应一个 $x_i$，第三部分表示等式右侧。然后采用迭代方法，具体实现步骤如下：

1. 寻找第一行 (Row 0) 中系数最大且为正的那个列 ($-c_i$)，即这列编号为 $i$，此时 $x_i$ 就作为“当前将要进入的基本变量”

2. 找到“当前将要进入的基本变量” $x_i$ 后，执行“比例测试”：将第三部分的列中的值（也就是 $\mathbf b$）除以每一行中第 $i$ 列的系数（$x_i$ 的系数），例如第 $j$ 行的 $b_j$ 变成 $b_j/A_{ji}$，但是如果 $A_{ji} \le 0$，那么第 $j$ 行将不执行“比例测试”，注意 Row 0 行也不执行“比例测试”。对所有执行了“比例测试”的行的比例，选择 **比例最小且为正** 的行，记行号为 $j$，如果有多个行，其比例为正且均为最小，那么随意选择其中一行即可。

3. 通过前两步，找到了“当前将要进入的基本变量” $x_i$，以及 $x_i$ 将要进入的行号 $j$。然后通过矩阵的基本行变换，使得第 $i$ 变成单位矩阵的第 $i$ 列，即，第 $i$ 列的 第 $j$ 行为 1，其余行为 0，注意这里 Row 0 行也参与行基本变换。通过这个变换，$x_i$ 已经进入了基本变量，由于此时 $x_i$ 的系数为 $1$，其值就是第三部分的列在第 $j$ 行的值，即 $x_i=b_j/A_{ji}$，$A_{ji}$ 是本次矩阵基本行变换之前的系数。 之前的位于第 $j$ 行的基本变量则被移除出去 。这里，“进入”指变量进入基本变量集合，“移除”指将变量从基本变量集合中移除出去。

4. 重复以上过程，直到 Row 0 行没有正数，即第二部分 ($-\mathbf c$ ）没有正分量，结束迭代。此时，所有基本变量的值均已确定，非基本变量的值为 0，也就是说，最优解 $\mathbf x=\begin{bmatrix}\mathbf x_B \\ \mathbf x_N\end{bmatrix}$ 已经确定，代入原始的目标函数 $z=\mathbf {cx}$ 即可求得最优值。

### 例子说明
有以下线性规划问题：

$$\begin{aligned} \min z &= -3x_1+8x_2
\\ s.t. \ 4x_1+2x_2 &\le 12 \\
2x_1+3x_2 & \le 6
\\ x_1, x_2 \ge 0\end{aligned}$$

第一步是将上述 LP 转换为标准形式，对两个不等式增加两个辅助变量，于是

$$\begin{aligned} \min z &= -3x_1+8x_2
\\ s.t. \ 4x_1+2x_2 + s_1 &= 12 \\
2x_1+3x_2 +s_2& = 6
\\ x_1, x_2, s_1, s_2 \ge 0\end{aligned}$$

根据 $z-\mathbf {cx}=0$ 以及 $A\mathbf {x=b}$，为相应表格如下，

|Row | $z$ | $x_1$|$x_2$|$s_1$|$s_2$| RHS| BV| ratio|
|---|---|---|---|---|---|---|---|---|
|0| 1| 3|-8|0|0|0|z=0| -|
|1|0|4|2|1|0|12|$s_1=12$|12/4=3|
|2|0|2|3|0|1|6|$s_2=6$|6/2=3|

由于 $s_1, \ s_2$ 是添加的辅助变量，所以其系数为 1， 在 $A$ 中的对应的列与单位矩阵对应的列相同，所以以 $s_1, \ s_2$ 为初始“基本变量”，RHS 列表示 “right hand side”，即 $\mathbf b$ 这列，BV 表示 basic variable 基本变量，ratio 表示各行“比例测试”后的比值。根据基本变量 $\mathbf x_B=B^{-1}\mathbf b$，这里 $B=I$ 为单位矩阵，所以 $\mathbf x_B=\mathbf b$，于是 $s_1=12, \ s_2=6$。

然后执行上述步骤 1，Row 0 行最正系数为 3，所以选中 $x_1$ 这列，接着执行“比例测试”，这列的 Row 1 和 Row 2 的系数均为正，所以全部参与“比例测试”（Row 0 永不参加“比例测试”），令 $b_j'=b_j/A_{ji}$，得到 ratio 列的值，选择其中最小的值，即 最小正比值，这里 $b_1'=b_2'$，故可以任选一行，不妨选择 Row 1 这行，接着执行“矩阵行基本变换”，使得 $A_{:,1}$ 这列为单位矩阵的列，其中 $A_{1,1}=1$，其余 $A_{j,1}=0, \ j \neq 1$。

矩阵行基本变换包含 $-\mathbf c$ 列和  RHS 列。

矩阵行基本变换之后，从 $x_1$ 到 RHS 各列的值已经确定，如下表中所示，

|Row | $z$ | $x_1$|$x_2$|$s_1$|$s_2$| RHS| BV| ratio|
|---|---|---|---|---|---|---|---|---|
|0| 1| 0|-19/2|-3/4|0|-9|z=-9| -|
|1|0|1|1/2|1/4|0|3|$x_1=12$|-|
|2|0|0|1|-1/4|1/2|0|$x_2=0$|-|

变换过程为：先将 Row 0 行 到 Row 2 行 分别乘以 $1/3, \ 1/4,\ 1/2$，然后 Row 0 行和 Row 2 行均各自减去 Row 1 行，为了使 Row 0 行 $z$ 的系数为 1，Row 0 再乘以 $3$。
此时 基本变量 BV 列的值很好确定，对每行，选择值为 1 的那些列，于是

Row 0 -> z

Row 1 -> $x_1$

Row 2 -> $x_2$

即， $\mathbf x_B=[z, x_1, x_2]^{\top}$，子矩阵 $B=I$ 为单位矩阵，所以 $\mathbf x_B=B^{-1} \mathbf b$，得到 $z=-9, \ x_1=3, \ x_2=0$。

此时由于 Row 0 行中对应 $A$ 矩阵的变量的系数均为 负，故迭代结束，最优解为 
$x_1=3, \  x_2=0$，最优值为 $z=-9$ 。（若 Row 0 行变量系数不全为 0，那么接着上表的结果，继续执行迭代）

# 其他例外情况

上面的例子中，添加的辅助变量 $s_1, \ s_2$ 在 $A$ 中的系数均为 $1$，使得这两列构成单位矩阵，即 $[A_{:,3}, \  A_{:,4}]=I_{2\times 2}$，但是如果约束条件中包含等式，或者是 “大于等于” 关系，等式使得 $A$ 中对应行全为 0，大于等于使得 $A$ 中对应行有 $-1$。对于“大于等于”这个情况，不能简单将这行乘以 $-1$ 使得变成“小于等于”关系，因为这会使得 RHS 列的值为 负，根据基本变量 $\mathbf x_B=B^{-1}\mathbf b$，这一行对应的基本变量值也是负，与 $\mathbf x \ge 0$ 矛盾。下面介绍两种解决方法。

## Two-Phase Method
考虑以下优化问题

$$\begin{aligned} \min \ 2x_1-x_2+x_3 &
\\ s.t. \ 2x_1+x_2-2x_3 & \le 8
\\ 4x_1-x_2+2x_3 & = 2
\\ 2x_1+3x_2-x_3 &\ge 4
\\ x_1, x_2,x_3 &\ge 0
\end{aligned}$$

为第一个和第三个不等关系分别添加变量 $s_1$ 和 $e_3$，于是单纯形表为

|z|$x_1$|$x_2$|$x_3$|$s_1$|$e_3$|RHS|
|--|--|--|--|--|--|--|
|1|-2| 1|-1|0|0|0|
|0|2|1|-2|1|0|8|
|0|4|-1|2|0|0|2|
|0|2|3|-1|0|-1|4|

这里 $A \in \mathbb R^{3,5}$，显然没有 $3\times 3$ 的单位矩阵，也就没有初始的“基本变量”。为约束条件 2 和 3 分别添加两个变量 $a_1$ 和 $a_3$，注意到目标函数中没有 $a_1$ 和 $a_3$，目标函数改为 $\min z=a_1+a_3$，表格为

|z|$x_1$|$x_2$|$x_3$|$e_3$|$s_1$|$a_1$|$a_3$|RHS|
|--|--|--|--|--|--|--|--|--|
|1|0| 0|0|0|0|-1|-1|0|
|0|2|1|-2|0|1|0|0|8|
|0|4|-1|2|0|0|1|0|2|
|0|2|3|-1|-1|0|0|1|4|

将 Row 2 和 Row 3 加到 Row 0 上，使得 Row 0 上 $a_1$ 和 $a_3$ 的系数为 0，这样 Row 0 中出现正系数，这就是 Phrase 1 阶段的数据表，使用 单纯形方法，最后数据表变为

|z|$x_1$|$x_2$|$x_3$|$e_3$|$s_1$|$a_1$|$a_3$|RHS|
|--|--|--|--|--|--|--|--|--|
|1|0| 0|0|0|0|-1|-1|0|
|0|0|0|-2.14|0.43|1|-0.29|-0.43|5.71|
|0|1|0|0.36|-0.07|0|0.21|0.07|0.71|
|0|0|1|-0.57|-0.29|0|-0.14|0.29|0.86|

显然 $x_1$ 和 $x_2$ 以及 $s_1$ 构成了这个阶段的最终基本变量集合。

然后是 phrase 2，将目标函数恢复成原来的目标函数，并删除 $a_1$ 和 $a_3$ 这两个列，此时表格为

|z|$x_1$|$x_2$|$x_3$|$e_3$|$s_1$|RHS|
|--|--|--|--|--|--|--|
|1|-2|1|-1|0|0|0|
|0|0|0|-2.14|0.43|1|5.71|
|0|1|0|0.36|-0.07|0|0.71|
|0|0|1|-0.57|-0.29|0|0.86|

将 Row 2 乘以 2 加到 Row 0 上，Row 3 乘以 -1 加到 Row 0 上，使得 **Row 0 上基本变量的系数为 0**，

|z|$x_1$|$x_2$|$x_3$|$e_3$|$s_1$|RHS|
|--|--|--|--|--|--|--|
|1|0|0|0.29|0.14|0|0.57|
|0|0|0|-2.14|0.43|1|5.71|
|0|1|0|0.36|-0.07|0|0.71|
|0|0|1|-0.57|-0.29|0|0.86|

然后使用单纯形方法求解，最后得到的基本变量的解就是原优化问题的最优解。